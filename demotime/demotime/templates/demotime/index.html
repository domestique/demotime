{% extends 'layout-user.html' %}
{% load demo_tags %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <div class="container">
        Your dashboard
    </div>
</div>
{% endblock %}

{% block styles %}
{{ block.super }}
<link rel="stylesheet" href="/static/styles/dashboard.css">
<link href="/static/styles/library/bootstrap.popover.css" type="text/css" media="all" rel="stylesheet" />
{% endblock %}

{% block content %}
<h1 class="heading">
    <strong>Your</strong> Dashboard
    <small><a href="{% url 'review-list' %}">View/Filter all demos</a></small>
</h1>

{% if available_projects %}
    <nav class="tertiary your_dashboard">
        {% include "includes/tertiary.html" %}
    </nav>
{% endif %}

<div class="dashboard aggregated_dashboard">
    <article style="margin-top: 30px">
        {% if open_reviews %}
            <h3 class="icon icon-inbox">
                Open demos you're <strong>reviewing</strong>
                <span class="help" title="These are demos that have been assigned
                to you to review. You can leave feedback and ultimately approve or
                reject a demo. Your approval status appears to the left."></span>
            </h3>
            <section class="emph_med aggregated_dashboard-reviewing">
                <div>
                    <ul>
                        {% for demo in open_reviews %}
                            {% include "includes/reviews_li.html" %}
                        {% endfor %}
                    </ul>
                </div>
            </section>
        {% endif %}
        {% if followed_demos %}
            <h3 class="icon icon-inbox">
                Open demos you're <strong>following</strong>
                <span class="help" title="Demos you are following do not require any
                action on your part. You can simply follow their progress."></span>
            </h3>
            <section class="emph_med aggregated_dashboard-following">
                <div>
                    <ul>
                        {% for demo in followed_demos %}
                            {% include "includes/reviews_li.html" %}
                        {% endfor %}
                    </ul>
                </div>
            </section>
        {% endif %}
        {% if message_bundles %}
            <h3 class="icon icon-inbox">
                Unread messages
                <small>
                    <a href="{% url 'inbox' %}" class="normal_text">view all</a> |
                    <a href="#" id="archive_all" class="normal_text">archive all</a>
                </small>
            </h3>
            <section class="emph_med aggregated_dashboard-messages">
                <div>
                    <div class="messages-list">
                        <ul>
                            {% for message in message_bundles %}
                                <li class="message_li {% if message.read %}de-emphasize{% endif %}">
                                    {% if message.review %}
                                        {% if message.review.creator != request.user %}
                                            <a data-prj="{{ message.review.project.pk }}" data-pk="{{ message.review.pk }}" title="Your approval status" class="has_bubble dt_link icon-{% reviewer_status message.review request.user %}" href="{{ message.review.get_absolute_url }}">DT-{{ message.review.pk }}</a>:
                                        {% else %}
                                            <a data-prj="{{ message.review.project.pk }}" data-pk="{{ message.review.pk }}" class="has_bubble dt_link" href="{{ message.review.get_absolute_url }}">DT-{{ message.review.pk }}</a>:
                                        {% endif %}
                                    {% endif %}
                                    <a class="{{ message.read }} icon icon-mail iframe lightbox_url" href="{{ message.get_absolute_url }}?display_state=hide_header">{{ message.title }}</a>
                                    {% include "includes/review_state.html" with demo=message.review %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </section>
        {% endif %}
        {% if open_demos %}
            <h3 class="icon icon-calendar">
                Open demos you've created
                <small>
                    <a href="{% url 'review-list' %}?creator={{ request.user.pk }}" class="normal_text">View all</a>
                </small>
            </h3>
            <section class="emph_med aggregated_dashboard-created">
                <div>
                    <ul>
                        {% for demo in open_demos %}
                            {% include "includes/reviews_li.html" %}
                        {% endfor %}
                    </ul>
                </div>
            </section>
        {% endif %}
        <h3>
            <strong>Projects</strong> you're a member of
            <span class="help" title="A Project consists of one or more demos.
            Think of it as a group of demos that all have something in common.
            Projects are a way of organizing demos."></span>
        </h3>
        <section class="emph_lower" style="margin-bottom: 0">
            <ul>
                {% if available_projects %}
                    {% for project in available_projects %}
                        <li><a href="{% url 'project-dashboard' project.slug %}">{{ project.name }}</a></li>
                    {% endfor %}
                {% else %}
                    <li>You aren't a member of any projects</li>
                {% endif %}
                {% if request.user.is_superuser %}
                    <li>
                        <a class="icon icon-plus" href="{% url 'project-create' %}">New project</a>
                    </li>
                {% endif %}
            </ul>
        </section>
    </article>
    {% include "includes/legend.html" %}
</div>

{% comment %}
<div class="tip">
    <strong>Power tip</strong>: You can now simply type in {{ site_settings.SERVER_URL }}/DT-1234 to be redirected to a demo.
</div>
{% endcomment %}
{% endblock %}

{% block scripts %}
<script src="/static/scripts/ArchiveAll.js"></script>
{{ block.super }}
<script>
$('.icon-mail.iframe').click(function() {
    $(this).parents('li').slideUp();
});

var archive_all = new DemoTime.ArchiveAll({
    url: '{% url "messages-json" %}'
});

{# Tour for project dash #}
if (!Cookies.get('seen_dash_updates')) {
    Cookies.set('seen_dash_updates', true, { expires: 365 })
    var steps = [{
        content: '<p>Check out these new project dashboards.</p>',
        highlightTarget: true,
        nextButton: true,
        target: $('.tertiary'),
        my: 'bottom center',
        at: 'top center'
    }, {
        content: '<p>Get a nice overview of project demos in your organization.</p>',
        highlightTarget: true,
        nextButton: true,
        target: $('.tertiary li:nth-child(2)'),
        my: 'bottom center',
        at: 'top center'
    }]

    var tour = new Tourist.Tour({
        steps: steps,
        tipClass: 'Bootstrap',
        tipOptions:{ showEffect: 'slidein' }
    });
    tour.start();
}
</script>
{% endblock %}
